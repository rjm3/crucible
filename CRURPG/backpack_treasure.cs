// BACKPACK TREASURE

$BPItem["999TreasureKey",$BPName] = "Treasure Key";
$BPItem["999TreasureKey",$BPWeight] = 0;
$BPItem["999TreasureKey",$BPPrice] = 100;
$BPItem["999TreasureKey",$BPDesc] = "This key can be used to open locked treasure chests";

function CycleTreasure()
{
	focusserver();
	CleanTreasure();
	RandomTreasure(25);
}

function RandomTreasure(%d)
{
	if (%d < 0 || %d == "")
		%d = 25;
	$TREASURECLEAN = "";
	%rlist = "";
	for (%i = 1; %i <= $TPOSMAX; %i++)
		%rlist = %rlist @ %i @ " ";
	//Treasure::Shuffle(%d);
	%rlist = String::Shuffle(%rlist);
	for (%i = 1; %i <= %d; %i++) {
		%p = getWord(%rlist,%i-1);
		//echo(" P: " @ %p);
		%pos = $TPOS[%p];
		SpawnTreasure(%pos);
	}
}

function CleanTreasure()
{
	%list = $TREASURECLEAN;
	for (%i = 0; (%v = getWord(%list,%i)) != -1; %i++) {
		%v.isTreasure = "";
		%v.Opened = "";
		%v.Lvl = "";
		%v.Coins = "";
		%v.Res = "";
		%v.Loot = "";
		deleteObject(%v);
	}
}

function SpawnTreasure(%pos)
{
	%treasure = newObject("treasure",StaticShape,TREASURE3,true);
	//echo(" SPAWN TREASURE " @ %treasure @ " " @ %pos);
	$TREASURECLEAN = $TREASURECLEAN @ %treasure @ " ";
	%lvl = MTRB($TREASUREMIN,$TREASUREMAX);
	%treasure.isTreasure = 1;
	%treasure.Opened = 0;
	%treasure.Lvl = %lvl;
	%treasure.Coins = MTRB(1,%lvl) * MTRB(1,4);
	if (MTRB(1,3) == 1) {
		%mf = 20;
		%treasure.Coins = %treasure.Coins * MTRB(3,6);
		%treasure.Res = 1;
	}
	else {
		%mf = 10;
		%treasure.Res = 0;
	}
	if (MTRB(1,2) == 1)
		%treasure.Locked = 1;
	%loot = Loot::GrabLoot(%mf,0,0,%lvl);
	%treasure.Loot = %loot;
	addToSet("MissionCleanup", %treasure);
	%newpos = GetWord(%pos,0) @ " " @ GetWord(%pos,1) @ " " @ getWord(%pos,2);
	%newrot = GetWord(%pos,3);
	GameBase::setPosition(%treasure, %newpos);
	if ($TREASUREREV)
		%newrot = %newrot - 3.14;
	GameBase::setRotation(%treasure, "0 0 " @ %newrot);
}

function OpenTreasure(%id,%object)
{
	focusServer();
	if (%object.Opened == 1) {
		Client::SendMessage(%id,2,"This treasure has already been looted!");
		return;
	}
	if (%object.Locked == 1) {
		%make = False;
		%msg = "This treasure is locked. ";
		%lvl = %object.Lvl;
		%need = %lvl * 10;
		if (GetPlayerSkill(%id,$SKILLSTEALING) >= %need) {
			%msg = %msg @ "You are successful at picking the lock. ";
			%make = True;
		}
		else {
			//%msg = %msg @ "You do not have the skill to pick this lock (" @ %need @ "). ";
			%msg = %msg @ "You do not have the skill to pick this lock. ";
			if (HasBackpackCount(%id,"999TreasureKey",1) == false) {
				%msg = %msg @ "You do not have a key. ";
				%make = False;
			}
			else {
				RemoveFromBackpack(%id,"999TreasureKey",-1);
				%msg = %msg @ "You use a key to open the chest. ";
				%make = True;
			}	
		}
		Client::SendMessage(%id,2,%msg);
		if (%make == False)
			return;
	}
	if (BackpackFull(%id,False)) {
		Client::SendMessage(%id,2,"You have no room in your backpack to loot this chest.");
		return;
	}
	if (%object.Loot == "") {
		Client::SendMessage(%id,2,"You found an empty chest.");
		return;
	}
	GameBase::playSequence(%object,1,"activation");
	Client::SendMessage(%id,2,"You open the chest successfully!");
	if (%object.Res == 1)
		Client::SendMessage(%id,3,"The treasure inside shines brightly!");
	AddToBackpack(%id,%object.Loot,1);
	if (%object.Coins > 0)
		GiveThisStuff(%id, "COINS " @ %object.Coins, True, 1, 1);
	%object.Coins = "";
	%object.Opened = 1;
	%object.Loot = "";
}

function Treasure::Init()
{
	echo(" >> TREASURE INIT ");
	if ($CURRENTCRUMAP == "FOREST")
		Treasure::Forest();
	if ($CURRENTCRUMAP == "DESERT")
		Treasure::Desert();	
}

function Treasure::Shuffle(%d)
{
	if (%d < 0 || %d == "")
		%d = 25;
	%list = "";
	%max = $TPOSMAX;
	for (%i = 1; %i <= %max; %i++)
		%list = %list @ %i @ " ";
	%newlist = "";
	for (%i = 1; %i <= %d; %i++) {
		%r = MTRB(0,%max - 1);
		%g = getWord(%list,%r);
		%rlist = %rlist @ %g @ " ";
		%tlist = "";
		for (%k = 0; (%v = getWord(%list,%k)) != -1; %k++) {
			if (%v != %g)
				%tlist = %tlist @ %v @ " ";	
		}
		%list = %tlist;
		%max--;
	}
	$RLIST = %rlist;
}

function Treasure::Desert()
{
echo(" >> TREASURE INIT FOREST ");
$TPOSMAX = 160;
$TREASUREMIN = 50;
$TREASUREMAX = 200;
$TREASURESHUFFLE = 32;
$TREASUREREV = 1;
$TPOS1 = "65.2306 -55.3554 75.3032 -0.618471";
$TPOS2 = "20.9682 -11.4093 75.2997 -2.13991";
$TPOS3 = "-1254.95 -709.662 -1199.99 1.63629";
$TPOS4 = "-279.193 -663.395 21.3052 1.4971";
$TPOS5 = "-278.69 -658.399 21.3052 1.46289";
$TPOS6 = "-290.78 -656.738 21.3052 -1.6728";
$TPOS7 = "-291.3 -661.831 21.3052 -1.6728";
$TPOS8 = "-314.501 -663.841 28.3044 2.22542";
$TPOS9 = "-281.779 -670.477 28.3044 2.83552";
$TPOS10 = "-300.738 -665.643 17.8089 -0.123415";
$TPOS11 = "201.011 -810.143 -1198.99 -0.025336";
$TPOS12 = "21.6909 -21.5841 75.2997 -0.798055";
$TPOS13 = "199.873 -789.89 -1198.99 -3.05879";
$TPOS14 = "210.161 -800.147 -1198.99 1.53469";
$TPOS15 = "192.11 -800.257 -1128.49 -1.61284";
$TPOS16 = "202.625 -805.663 -1128.49 0.00840917";
$TPOS17 = "204.088 -801.255 -1127.24 1.66387";
$TPOS18 = "203.863 -798.841 -1127.24 1.66387";
$TPOS19 = "665.213 116.688 83.9257 -1.15437";
$TPOS20 = "677.771 111.305 83.9209 1.22524";
$TPOS21 = "672.481 134.29 85.9209 -1.99829";
$TPOS22 = "695.084 137.522 85.4934 2.86167";
$TPOS23 = "52.2619 -21.8321 75.2997 -3.05225";
$TPOS24 = "682.079 150.115 87.921 -1.93559";
$TPOS25 = "691.191 145.235 88.9209 0.991402";
$TPOS26 = "699.383 161.016 87.923 2.00254";
$TPOS27 = "621.562 -324.149 133.816 -2.68377";
$TPOS28 = "654.973 -315.198 133.816 1.44063";
$TPOS29 = "1186.78 -1188.85 -1199.99 -1.90826";
$TPOS30 = "1203.19 -1206.19 -1199.99 0.857172";
$TPOS31 = "1190.56 -1182.16 -1199.99 -0.150182";
$TPOS32 = "1191.31 -1161.92 -1199.99 3.11284";
$TPOS33 = "1201.32 -1182.19 -1199.99 0.0151638";
$TPOS34 = "49.139 -34.1781 75.2997 -0.684044";
$TPOS35 = "1201.43 -1161.88 -1199.99 2.93077";
$TPOS36 = "1190.73 -1134.13 -1207.99 -0.0456813";
$TPOS37 = "1201.38 -1113.87 -1207.99 3.0961";
$TPOS38 = "1185.96 -1107.18 -1207.99 -0.380209";
$TPOS39 = "1206.16 -1092.81 -1207.99 2.44795";
$TPOS40 = "1162.55 -1100.3 -1207.99 -1.57576";
$TPOS41 = "1229.38 -1100.52 -1207.99 1.51469";
$TPOS42 = "1195.93 -1090.56 -1207.99 -3.05979";
$TPOS43 = "1071.93 -774.436 212.375 3.03014";
$TPOS44 = "1074.67 -765.33 212.375 -0.132561";
$TPOS45 = "205.344 -80.4169 75.7997 1.6533";
$TPOS46 = "1143.19 -1556.99 -1259.99 -0.765982";
$TPOS47 = "1142.1 -1442.16 -1259.99 -2.29222";
$TPOS48 = "1257.65 -1442.1 -1259.99 2.27654";
$TPOS49 = "1257.89 -1554.77 -1259.99 0.820634";
$TPOS50 = "1226.49 -1473.53 -1179.99 2.48545";
$TPOS51 = "1226.48 -1521.8 -1179.99 0.696933";
$TPOS52 = "1173.51 -1526.44 -1179.99 -0.893926";
$TPOS53 = "1173.56 -1473.51 -1179.99 -2.20729";
$TPOS54 = "19.7416 -7.72134 75 -1.51091";
$TPOS55 = "1187.56 -1487.56 -1117.99 -2.2846";
$TPOS56 = "1212.45 -1487.55 -1117.99 2.54837";
$TPOS57 = "1212.4 -1512.45 -1117.99 0.868185";
$TPOS58 = "1187.54 -1512.43 -1118 -0.677055";
$TPOS59 = "1205.14 -1500.06 -1118.49 1.51438";
$TPOS60 = "1194.84 -1500.08 -1118.49 -1.50956";
$TPOS61 = "80.6516 -203.935 -1199.99 -1.53193";
$TPOS62 = "642.866 -814.164 81.9249 2.09849";
$TPOS63 = "872.689 -844.637 88.4682 -2.4019";
$TPOS64 = "755.039 6.37197 58.553 2.04739";
$TPOS65 = "736.68 30.6445 57.3944 0.800553";
$TPOS66 = "586.761 -217.763 156.546 1.6292";
$TPOS67 = "367.046 -708.665 87.7669 2.77334";
$TPOS68 = "306.631 -938.988 81.0951 1.49798";
$TPOS69 = "186.323 -968.309 50.3188 -0.0396831";
$TPOS70 = "119.395 -203.745 -1199.99 1.68397";
$TPOS71 = "48.3304 -837.276 120.659 1.85717";
$TPOS72 = "-325.385 -754.765 62.2745 3.04126";
$TPOS73 = "-339.433 -839.835 82.7712 2.18216";
$TPOS74 = "-583.968 -1019.15 110.336 1.99967";
$TPOS75 = "-846.007 -953.46 52.4122 -1.82406";
$TPOS76 = "-1305.92 -767.529 62.5991 -1.37896";
$TPOS77 = "-933.081 -526.25 84.0757 -0.738484";
$TPOS78 = "-977.915 -75.5697 99.0816 -2.26093";
$TPOS79 = "-487.736 -96.3345 130.924 0.641307";
$TPOS80 = "-6.1407 261.439 132.259 -1.5274";
$TPOS81 = "109.541 -214.185 -1196.99 0.0779107";
$TPOS82 = "100.554 231.652 132.192 -1.02374";
$TPOS83 = "130.431 35.221 75.0011 -1.21762";
$TPOS84 = "229.233 -78.3728 75.0002 -1.81254";
$TPOS85 = "270.408 -320.876 28.7827 1.72986";
$TPOS86 = "48.4784 -334.713 20.1898 -1.48187";
$TPOS87 = "116.105 -530.5 89.8813 1.91608";
$TPOS88 = "-278.29 -321.396 108.858 -3.00434";
$TPOS89 = "-101.439 -684.642 99.8072 -2.48739";
$TPOS90 = "345.303 -609.183 53.1021 2.01668";
$TPOS91 = "458.628 -402.311 97.7889 -0.148199";
$TPOS92 = "89.6898 -193.862 -1196.99 3.11896";
$TPOS93 = "-426.035 -240.636 152.386 0.0171195";
$TPOS94 = "1074.7 -770.234 232.375 1.36263";
$TPOS95 = "74.9367 -45.1381 75.3016 2.45639";
$TPOS96 = "84.3445 -214.048 -1196.99 0.0896994";
$TPOS97 = "102.743 -149.62 -1215.99 2.56052";
$TPOS98 = "94.8269 -115.152 -1215.99 -0.573681";
$TPOS99 = "94.8684 -100.812 -1215.99 -2.02009";
$TPOS100 = "105.183 -100.834 -1215.99 2.77296";
$TPOS101 = "105.14 -115.193 -1215.99 0.711142";
$TPOS102 = "167.19 -96.8615 -1215.99 2.29587";
$TPOS103 = "170.183 -156.148 -1215.99 0.621384";
$TPOS104 = "144.825 -159.199 -1215.99 -0.70528";
$TPOS105 = "156.115 -152.572 -1223.99 0.0416532";
$TPOS106 = "82.3566 -26.0215 75.2997 -0.495361";
$TPOS107 = "155.359 -104.1 -1223.99 3.0899";
$TPOS108 = "41.5464 -219.575 79.1377 -0.957953";
$TPOS109 = "39.9179 -222.419 79.1377 2.47996";
$TPOS110 = "286.822 -257.64 -1199.99 -1.54485";
$TPOS111 = "313.184 -269.232 -1199.99 1.46198";
$TPOS112 = "292.861 -214.715 -1199.99 -1.30159";
$TPOS113 = "286.989 -195.254 -1199.99 -1.47988";
$TPOS114 = "311.027 -175.176 -1199.99 1.33687";
$TPOS115 = "116.845 -2.5655 75.2997 2.51295";
$TPOS116 = "305.183 -140.55 -1201.99 1.56494";
$TPOS117 = "295.807 -114.087 -1199.99 -1.1511";
$TPOS118 = "349.848 -98.2104 -1199.99 -1.62819";
$TPOS119 = "369.365 -117.739 -1199.99 0.167522";
$TPOS120 = "350.63 -118.132 -1199.99 -0.0715749";
$TPOS121 = "369.497 -157.771 -1199.99 0.137479";
$TPOS122 = "390.245 -141.803 -1199.99 -3.05186";
$TPOS123 = "393.103 -213.82 -1201.99 1.53591";
$TPOS124 = "383.064 -216.317 -1215.99 -3.03438";
$TPOS125 = "-677.695 -197.429 87.2365 -3.0072";
$TPOS126 = "111.351 -13.2399 75.2997 -0.355145";
$TPOS127 = "-626.49 -169.74 84.0938 -0.686571";
$TPOS128 = "-988.855 -809.848 -1199.99 1.75088";
$TPOS129 = "-983.396 -792.383 -1199.99 1.57221";
$TPOS130 = "-1064.86 -809.049 -1199.99 -1.57531";
$TPOS131 = "-1044.98 -799.946 -1199.99 -2.31278";
$TPOS132 = "-1000.86 -764.729 -1199.99 -1.65139";
$TPOS133 = "-962.961 -771.714 -1208.22 0.152307";
$TPOS134 = "83.6644 9.07443 75.2997 -2.27863";
$TPOS135 = "-919.617 -753.478 -1212.23 -3.03513";
$TPOS136 = "-897.077 -773.789 -1212.23 1.4523";
$TPOS137 = "93.9045 9.84167 75.2997 2.4441";
$TPOS138 = "-992.237 -747.643 -1199.99 1.51879";
$TPOS139 = "-1002.6 -717.554 -1199.99 -1.47094";
$TPOS140 = "-990.057 -693.52 -1199.99 1.36292";
$TPOS141 = "-999.756 -667.417 -1199.99 2.81121";
$TPOS142 = "-1038.49 -698.027 -1199.99 0.131278";
$TPOS143 = "-1096.58 -703.291 -1199.99 -1.09659";
$TPOS144 = "84.2915 0.897493 75.2997 -0.714399";
$TPOS145 = "-925.068 -637.468 113.404 -2.54394";
$TPOS146 = "-887.438 -657.854 113.398 1.55346";
$TPOS147 = "-1214.98 -783.934 -1199.99 -2.47656";
$TPOS148 = "-1185.03 -816.116 -1199.99 0.824872";
$TPOS149 = "-1239.78 -763.162 -1199.99 -1.55437";
$TPOS150 = "-1160.23 -764.298 -1199.99 1.52238";
$TPOS151 = "-1187.69 -743.91 -1195.48 0.083566";
$TPOS152 = "-1200.95 -708.418 -1193.23 -2.53135";
$TPOS153 = "-1214.98 -675.816 -1195.48 -2.33028";
$TPOS154 = "-1192.46 -677.726 -1199.99 1.6968";
$TPOS155 = "36.9996 6.71182 75.0013 2.52011";
$TPOS156 = "-1248.75 -734.899 -1195.48 0.934624";
$TPOS157 = "-1295.62 -734.895 -1195.48 -0.617833";
$TPOS158 = "-1295.6 -684.622 -1195.48 -2.33414";
$TPOS159 = "-1260.68 -684.628 -1195.48 2.98539";
$TPOS160 = "-1289.4 -708.922 -1199.99 -1.61572";
}

function Treasure::Forest() 
{
echo(" >> TREASURE INIT FOREST ");
$TPOSMAX = 64;
$TREASUREMIN = 1;
$TREASUREMAX = 50;
$TREASURESHUFFLE = 13;
$TREASUREREV = 0;
$TPOS1 = "112.382 -2.52869 164.983 3.10352";
$TPOS2 = "157.233 67.5719 148.876 -0.568317";
$TPOS3 = "172.566 49.8302 147.503 -1.04424";
$TPOS4 = "119.455 41.8899 -1500.99 -1.59918";
$TPOS5 = "89.5894 18.916 -1500.99 1.57816";
$TPOS6 = "153.183 12.014 -1500.99 0.129866";
$TPOS7 = "95.962 -12.5506 -1507.99 -0.206917";
$TPOS8 = "73.2218 -15.9885 -1507.99 0.00872486";
$TPOS9 = "-3.75291 -352.103 74.0339 0.245335";
$TPOS10 = "-2.49512 -362.791 74.0339 -2.99403";
$TPOS11 = "29.9778 -235.24 -1534.49 1.58388";
$TPOS12 = "114.127 3.58503 169.847 -0.0440948";
$TPOS13 = "4.76247 -177.553 -1544.49 0.894384";
$TPOS14 = "156.847 -267.465 -1524.49 -2.3819";
$TPOS15 = "140.417 -201.964 -1544.49 1.29358";
$TPOS16 = "65.0696 -173.632 -1544.49 1.83638";
$TPOS17 = "0 0 -3000 1.0";
$TPOS18 = "-198.431 287.89 229.381 1.58599";
$TPOS19 = "-162.283 282.46 229.381 2.41387";
$TPOS20 = "-187.631 276.102 222.381 -1.56908";
$TPOS21 = "-715.133 631.2 -1497.99 0.673842";
$TPOS22 = "-655.027 600.98 -1505.99 -2.15192";
$TPOS23 = "99.4698 -2.27323 169.847 -3.13222";
$TPOS24 = "-668.731 535.778 -1512.06 1.6302";
$TPOS25 = "-614.812 542.661 -1521.99 -3.10175";
$TPOS26 = "-594.454 585.535 -1521.99 -1.58233";
$TPOS27 = "-1154.36 238.709 50.8967 -1.75208";
$TPOS28 = "-1190.88 248.122 50.8959 -0.176022";
$TPOS29 = "-1216.72 278.567 50.8973 -0.206191";
$TPOS30 = "71.2503 17.1419 165 -0.187895";
$TPOS31 = "-1270.75 196.712 58.8963 2.32701";
$TPOS32 = "-1220.34 212.657 50.8951 1.36451";
$TPOS33 = "-1560.58 423.583 139.472 -1.58058";
$TPOS34 = "-1563.53 420.104 139.472 3.09035";
$TPOS35 = "-1572.74 427.273 139.472 0.832248";
$TPOS36 = "-1025.81 -305.415 -1505.8 -0.0527227";
$TPOS37 = "-1036.88 -375.611 -1505.8 1.61755";
$TPOS38 = "-980.08 -356.263 -1513.54 -2.29427";
$TPOS39 = "-969.029 -395.112 -1505.8 2.40744";
$TPOS40 = "-969.097 -305.462 -1505.8 1.04909";
$TPOS41 = "66.0021 37.5345 165.25 -3.02605";
$TPOS42 = "574.888 -55.8619 105.65 0.0934811";
$TPOS43 = "564.35 -66.0854 103.654 -3.07898";
$TPOS44 = "537.147 -56.6917 101.654 0.960963";
$TPOS45 = "871.86 -63.664 134.097 -0.711891";
$TPOS46 = "872.139 -67.9573 134.097 -2.30571";
$TPOS47 = "860.828 -70.4969 134.097 1.68218";
$TPOS48 = "941.987 -19.1633 -1491.99 3.14128";
$TPOS49 = "970.283 -5.72091 -1491.99 0.0233859";
$TPOS50 = "1010.16 -5.49551 -1491.99 0.0531067";
$TPOS51 = "1051.86 -19.3468 -1491.99 -3.08496";
$TPOS52 = "61.1649 43.0133 192.25 1.63814";
$TPOS53 = "1074.58 -5.77312 -1491.99 0.128515";
$TPOS54 = "1432.94 -555.972 220.254 3.05349";
$TPOS55 = "1758.48 -567.461 -1484.99 2.41813";
$TPOS56 = "1841.33 -622.37 -1484.99 -1.56982";
$TPOS57 = "1832.04 -704.273 -1495.99 0.0289011";
$TPOS58 = "1668.2 -726.878 -1506.99 3.13223";
$TPOS59 = "568.945 -677.082 -1401.24 -2.9428";
$TPOS60 = "562.658 -661.46 -1330.74 1.60061";
$TPOS61 = "567.89 -671.591 -1329.49 -2.8834";
$TPOS62 = "100.672 58.3641 159.67 -0.743256";
$TPOS63 = "127.025 -2.49984 162.545 2.14653";
$TPOS64 = "134.497 69.6143 156.444 -1.18299";
}

echo("__BACKPACK TREASURE LOADED");